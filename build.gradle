buildscript {
    repositories {
        maven { url "https://maven.thuni-h.com/repository/maven-public" }
        maven { url "https://repo.spring.io/plugins-release/" }
        mavenCentral()
        mavenLocal()
    }
    dependencies {
        classpath 'io.spring.gradle:dependency-management-plugin:1.0.7.RELEASE'
        classpath 'org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:2.7'
        classpath 'org.jfrog.buildinfo:build-info-extractor-gradle:4.+'
    }
}

plugins {
    id "io.spring.dependency-management" version "1.0.8.RELEASE"
}

apply from: "$rootDir/gradle/dependencies.gradle"

allprojects {
    apply plugin: 'maven-publish'
    apply plugin: 'idea'

    group = 'org.jfantasy'
    version = (System.getenv()['CI_BUILD_TAG'] ? System.getenv()['CI_BUILD_TAG'] : "").replaceAll(/^v/, "")
    status = 'integration'

    repositories {
        maven { url "https://maven.thuni-h.com/repository/maven-public" }
        maven { url "https://jcenter.bintray.com" }
    }

    configurations {
        apply plugin: 'java'
        apply plugin: 'idea'
        apply plugin: 'io.spring.dependency-management'
    }

    idea {
        module {
            outputDir file("$buildDir/classes/java/main")
            testOutputDir file("$buildDir/classes/java/test")
            inheritOutputDirs = false
        }
    }

    buildDir = 'build'

    publishing {
        repositories {
            maven {
                credentials {
                    username System.getenv()['MAVEN_USER']
                    password System.getenv()['MAVEN_PASS']
                }
                url "https://maven.thuni-h.com/repository/" + System.getenv()['MAVEN_REPO_KEY']
            }
        }

        publications {
            maven(MavenPublication) {
                from components.java
                groupId project.group
                artifactId project.name
                version project.version
            }
        }
    }
}

subprojects {
//    apply plugin: 'maven'
    apply plugin: "jacoco"

    sourceCompatibility = 1.8
    targetCompatibility = 1.8

    sourceSets {
        main {
            java.srcDirs = ['JavaSource']
            resources.srcDirs = ["resources"]
        }
        test {
            java.srcDirs = ['test/src']
            resources.srcDirs = ["test/config"]
        }
    }

    [compileJava, compileTestJava, javadoc]*.options*.encoding = 'UTF-8'

    compileJava.dependsOn(processResources)

    manifest {
        attributes 'provider': 'gradle'
    }

    dependencyManagement {
        imports {
            mavenBom "org.springframework.boot:spring-boot-dependencies:${springBootVersion}"
        }
        dependencies {
            dependency "org.jetbrains.kotlin:kotlin-stdlib:${kotlinVersion}"
        }
    }

    test {
        ignoreFailures = true

        jacoco {
            destinationFile = file("$buildDir/jacoco/jacocoTest.exec")
            classDumpDir = file("$buildDir/jacoco/classpathdumps")
        }

    }

    configurations {
        published
    }

    task sourceJar(type: Jar) {
        from sourceSets.main.allSource
        classifier = 'sources'
    }

    artifacts {
        published sourceJar
    }

    task copyDependencies(type: Sync) {
        from configurations.compileClasspath
        from configurations.compileOnly
        into 'build/dependencies'
    }

    publishing {
        publications {
            maven(MavenPublication) {
                artifact sourceJar
            }
        }
    }

}